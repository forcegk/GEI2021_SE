\documentclass[a4paper,openright,12pt]{article}

\include{preamble/packages}
\include{preamble/bibliography}

\setpapersize{A4}       %  DIN A4
\setmargins{3cm}        % margen izquierdo
{2cm}                   % margen superior
{15cm}                  % anchura del texto
{22.5cm}                % altura del texto
{10pt}                  % altura de los encabezados
{1cm}                   % espacio entre el texto y los encabezados
{0pt}                   % altura del pie de página
{2cm}                   % espacio entre el texto y el pie de página

\begin{document}

\author {Alonso Rodríguez}
\title {Trabajo Tutelado II}

% Título
\maketitle

% Justificamos el texto
\justifying{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                     INTRODUCCIÓN                                                      %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Introducción}
El objetivo de esta práctica es programar un sistema que responda a los siguientes requerimientos:
\begin{itemize}    
    \item Se dan dos conjuntos de 10 ángulos, que se almacenan en dos arrays en grados, minutos y segundos.
    \item La tarea 1 determina cuales son complementarios y cuales suplementarios.
    \item La tarea 2 cuenta el número de ángulos complementarios, enciende el LED1 (verde - PTD5) y se muestra el resultado en el LCD, hasta que el usuario pulse SW1.
    \item La tarea 3 cuenta el número de ángulos suplementarios, muestra el resultado en el LCD y enciende el LED2 (Rojo - PTE29) hasta que el usuario pulse SW1.
    \item La tarea 4 cuenta el número de ángulos que no son ni complementarios ni suplementarios, muestra el resultado en el LCD y enciende alternativamente el LED1 y el LED2
          hasta que el usuario pulse SW1.
    \item Cuando las tareas han finalizados, la tarea 5 enciende ambos leds, hasta que se pulse SW1 o SW2.
\end{itemize}

El sistema se implementa sobre la placa FRDM-KL46Z.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                    ESPECIFICACIÓN                                                     %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Especificación}
\subsection{Interfaz con el Sistema}\label{design_button_translation}
La interacción con el sistema se realiza mediante los switches físicos SW1 y SW2. % TODO posible \ref (?)

\subsection{Flujo del Programa}\label{pseudo_program_flow}
El programa debe inicializar las tareas al inicio de su ejecución (\ref{tasks}).

El funcionamiento de cada tarea será el siguiente:
\begin{itemize}
    \item init:
    \begin{samepage}    
    \begin{minted}{c}
task1 = task_create()
// [...]
task5 = task_create()
task_delete_self()
    \end{minted}
    \end{samepage}
    \item task1:
    \begin{samepage}    
    \begin{minted}{c}
for(array...){
    result = compare_angles(array1, array2)

    if(result == complementary)
        os_event_set(FLAG_ANGLE, task2)
    else if(result == supplementary)
        os_event_set(FLAG_ANGLE, task3)
    else
        os_event_set(FLAG_ANGLE, task4)
}
os_event_set(FLAG_TAKEOVER, task2)
task_delete_self()
    \end{minted}
    \end{samepage}
    \item task2:
    \begin{samepage}    
    \begin{minted}{c}
while(1){
    // PREGUNTA PARA DÍA 16: Los eventos se garantiza que se entreguen
    // en orden? Pensé en usar un mutex si fuese necesario que la task
    // mostrase el número MIENTRAS se cuenta

    result = os_event_wait_or(FLAG_ANGLE | FLAG_TAKEOVER, MAX_TIMEOUT)
    
    if(os_event_get(result) & FLAG_ANGLE)
        count++
    // pueden darse ambos eventos simultaneamente (no else)
    if(os_event_get(result) & FLAG_TAKEOVER)
        lcd_write(count)
        led_write(LED_GREEN, 1)
        while(!sw1)
}
led_write(LED_GREEN, 0)
os_event_set(FLAG_TAKEOVER, task3)
task_delete_self()
    \end{minted}
    \end{samepage}
    \item task3:
    \begin{samepage}    
    \begin{minted}{c}
while(1){
    // idem a task2 pero con LED_RED
}
led_write(LED_RED, 0)
os_event_set(FLAG_TAKEOVER, task4)
task_delete_self()
    \end{minted}
    \end{samepage}
    \item task4:
    \begin{samepage}    
    \begin{minted}{c}
while(1){
    // idem a task2 pero con ambos led (alternativamente)
}
led_write(LED_GREEN, 0)
led_write(LED_RED, 0)
os_event_set(FLAG_TAKEOVER, task5)
task_delete_self()
    \end{minted}
    \end{samepage}
    \item task5:
    \begin{samepage}    
    \begin{minted}{c}
result = os_event_wait_or(FLAG_TAKEOVER, MAX_TIMEOUT)
led_write(LED_GREEN, 1)
led_write(LED_RED, 1)

// queda a investigar qué ocurre en la fase de implementación
    \end{minted}
    \end{samepage}

\end{itemize}

\subsection{Diagrama de Tareas}\label{tasks}
\subsubsection{Tareas y eventos}
El diagrama muestra la comunicación que existe entre Task1 y el resto de las tasks, siguiendo el pseudocódigo propuesto en \ref{pseudo_program_flow}, en el que Task1 envía un evento
a la task correspondiente para que cuente la relación entre los ángulos.

Además, se puede observar que hay dos tipos de líneas:
\begin{itemize}
    \item Las líneas sólidas indican transmisión de datos de una task a otra, en este caso el envío de eventos.
    \item Las líneas rayadas indican la cesión del control y posterior eliminación de la tarea invocadora.
\end{itemize}

Por legibilidad no se ha incluido la creación de las tareas, ya que todas son creadas por init al inicio del programa.

\subsubsection{Representación}
\begin{center}
\begin{tikzpicture}[->,>=stealth, shorten >=1pt, auto, node distance=3.2cm, semithick]
    \tikzstyle{every state}=[draw=black,text=black]

    % Nodo inicial
    \node[initial,state] (init)                                 {$\text{init}$};

    % Tareas
    \node[state, right=0.5cm]           (task1)   [below right of=init]        {$\text{Task1}$};
    \node[state, right=0.8cm]           (task2)   [above right of=task1]       {$\frac{\text{Task2}}{\text{\textcolor{green}{\punto}}}$};
    \node[state, right=0.8cm]           (task3)   [right       of=task1]       {$\frac{\text{Task3}}{\text{\textcolor{red}{\punto}}}$};
    \node[state, right=0.8cm]           (task4)   [below right of=task1]       {$\frac{\text{Task4}}{\text{\textcolor{green}{\punto} $\leftrightarrow$ \textcolor{red}{\punto}}}$};
    \node[state, right=2cm]             (task5)   [right       of=task4]       {$\frac{\text{Task5}}{\text{\textcolor{green}{\punto} \& \textcolor{red}{\punto}}}$};

    \path[sloped,anchor=south]
        (task1) edge                node {comp.}             (task2)
                edge                node {supl.}             (task3)
                edge                node {otro}             (task4)
    ;
    \path[dashed]
        (init)  edge [bend right=10,looseness=0.5]      node {}          (task1)
        (task1) edge [bend right=10,looseness=0.5]      node {}          (task2)

        (task2) edge                node {SW1}          (task3)
        (task3) edge                node {SW1}          (task4)

        (task4) edge                node {SW1 or SW2}   (task5)
    ;
\end{tikzpicture}
\end{center}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                    IMPLEMENTACIÓN                                                     %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Implementación}
\subsection{Decisiones de diseño}
A completar en segunda entrega.

\subsection{Detalles de Implementación}
A completar en segunda entrega.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                  DESCRIPCIÓN EVENTOS                                                  %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Intercomunicación mediante Eventos}
\subsection{Motivación}
Los sistemas informáticos necesitan comunicación entre ellos, y para satisfacer esta necesidad existen múltiples paradigmas.
En nuestro caso necesitamos comunicación entre procesos, y como se explica en el temario de la asignatura, existen múltiples
opciones para realizar esto mismo, entre otras:
\begin{itemize}
    \item Comunicación mediante Eventos
    \item Comunicación mediante Mensajes (Uso de una Mailbox)
\end{itemize}

\subsection{Decisión de Diseño}
En este caso se ha escogido la comunicación por eventos, a pesar de haber pensado inicialmente en una comunicación mediante mensajes, debido a que considero
que puedo aprender más utilizando los eventos (sistema que no he usado como tal), y queda un sistema definitivamente dinámico, en el que prácticamente usamos los elementos como
``paquetes enrutados'', que llegan a receptores en una red, y además siendo utilizados también como método de señalizado a modo de testigo.

Todo esto desde mi punto de vista hace que resulte un sistema conceptualmente bastante satisfactorio, en el que podemos visualizar una intensiva comunicación inter-proceso.

\subsection{Explicación detallada}
No he encontrado tanta información como me gustaría acerca de este tema (\textcolor{blue}{solicitar sugerencia de bibliografía}), a parte de en la documentación de \emph{ARM
Keil} \autocite[\text{Event Flag Management}]{keil_function_reference}.

Por el momento podemos comentar que contamos con 6 rutinas, con las que podemos realizar toda la gestión de eventos:
\begin{samepage}
\begin{center}
\begin{tabular}{ | c | >{\centering\arraybackslash}m{11cm} | }
    \hline
    Rutina              &   Descipción\\
    \hline
    \texttt{os\_evt\_clr}        &   Elimina uno o más event flags de una tarea\\
    \hline
    \texttt{os\_evt\_get}        &   Devuelve las eventa flags que hicieron salir del \texttt{os\_evt\_wait\_or}\\
    \hline
    \texttt{os\_evt\_set}        &   Activa una o más flags de un evento de una tarea\\
    \hline
    \texttt{os\_evt\_wait\_and}  &   Espera a que se activen todos los flags necesarios\\
    \hline
    \texttt{os\_evt\_wait\_or}   &   Espera a que se active alguno de los flags necesarios\\
    \hline
    \texttt{isr\_evt\_set}       &   Activa una o más flags de un evento de una tarea, sólo activable desde dentro de una rutina de interrupción\\
    \hline
\end{tabular}
\end{center}
\end{samepage}

\subsection{Comportamiento Apreciado}
Aquí serán completadas todos los matices que apreciemos con este sistema en el que aún no he programado, por lo que es muy probable que se me
escapen cosas actualmente que al momento de la implementación se añadirán aquí y donde sea correspondiente.


\clearpage
\begin{flushleft}
\printbibliography[]{}
\end{flushleft}
\end{document}